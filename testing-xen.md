# Testing Xen Self-Ballooning

First I tried to run xen using Alpine OS live CD. I was able to boot through live USB, but running a guest OS on live CD was complicated since it required to create LVM for the guest.

Then I tired to run Xen on KVM under nested virtualization. I Installed Debain 8 on a VM and installed Xen packages on that, following [Xen Beginner's guide](http://wiki.xenproject.org/wiki/Xen_Project_Beginners_Guide). Then I tried up the Xen kernel, but it did not boot up. I thought that the problem was with nested virtualization. I found how to enable nested virtualization in KVM [here](https://wiki.archlinux.org/index.php/KVM#Nested_virtualization). Xen still did not boot up. Lookng at the dmesg, I found out that some virtual device was causing problem in booting. I tried to remove all the unnecessary devices, but it still did not boot up. I gave up trying to run Xen under KVM.

Then I installed Xen on Arch linux. It was simple enough following the guide at [arch linux wiki](https://wiki.archlinux.org/index.php/Xen). Then I booted up the xen kernel installed in the previous step. Next, I tried to create a Xen DomU VM using libvirt, but turns out that `libvirt` for arch linux is not compiled with xen support (given as a warning [here](https://wiki.archlinux.org/index.php/Libvirt#Server) in Arch wiki). So, I had to use [ABS](https://wiki.archlinux.org/index.php/Arch_Build_System) to recompile libvirt with xen support. Using `virt-manager`, I was able to create a `ubuntu14.04` VM with 1 CPU and 2GB ram under Xen full virtualization.

Next step was to test `ballooning` and `self-balloning`. Ballooning was simple, use either `xl set-mem [domain] [memory]` command (documentation about xl given [here](http://xenbits.xen.org/docs/4.2-testing/man/xl.1.html)), or use virt-manager to set the memory. Self-ballooning requires Transcendent memory to be enabled in Xen host and guest. After much struggle, I found out that it was compiled as a kernel module with the kernel, and I just had to do `modprobe tmem` in both - host and guest to enable it. Enabling tmem in guest also enabled slef-ballooning. I did not see self-ballooning in action when the guest memory was 2GB as there was hardly any free memory, but on increasing the guest's memory to 4GB and rebooting it, I could see the memory of guest reduce according to the free memory it had.
